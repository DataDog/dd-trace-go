stages:
  - setup
  - apm-sdks-benchmarks

variables:
  BENCHMARK_URL: "https://github.com/DataDog/apm-sdks-benchmarks.git"
  BRANCH: "dario.castane/go"
  DIR: "apm-sdks-benchmarks"

setup-benchmark:
  image: $BASE_CI_IMAGE
  stage: setup
  script: |-
    git clone --branch $BRANCH $BENCHMARK_URL $DIR
    cd $DIR
    cp flow/webserver/env.template .env
    cat >> .env << EOF
    LANGUAGE=go
    FLOW=webserver
    APP=go-prof-app
    BP_BENCHMARKS_CONFIGURATION=${CONFIG}
    EOF
    chmod +x run-full-benchmarks.sh
  artifacts:
    paths:
      - $DIR/
    expire_in: 1d
  timeout: 1h

run_benchmark:
  image: $BASE_CI_IMAGE
  stage: apm-sdks-benchmarks
  needs: setup-benchmark
  rules:
    - if: $CI_COMMIT_BRANCH = hannahkm/apm-sdks-benchmarks # TODO: this should run on a schedule
      when: always
    - when: manual
  parallel: 
    matrix:
      CONFIG:
        - "datadog-latest"
        - "baseline"
  script: |-
    cd $DIR
    ./run-full-benchmarks.sh
  timeout: 1h