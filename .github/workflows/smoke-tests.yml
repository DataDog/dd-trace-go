name: Smoke Tests

on:
  workflow_call: # allows to reuse this workflow
    inputs:
      ref:
        description: 'The branch to run the workflow on'
        required: true
        type: string
  push:
    branches:
      - main
      - release-v*
    tags:
      - '**'
  schedule: # nightly
    - cron: "0 0 * * *"
  workflow_dispatch: {} # manually
  pull_request:
    branches:
      - '**'

jobs:
  go-get-u:
    #  Run go get -u to upgrade dd-trace-go dependencies to their
    #  latest minor version and see if dd-trace-go still compiles.
    #  Related to issue https://github.com/DataDog/dd-trace-go/issues/1607
    name: 'dd-trace-go still works after go get -u'
    runs-on: ubuntu-latest
    env:
      PACKAGES: ./internal/... ./ddtrace/... ./profiler/... ./appsec/...
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}
      - uses: actions/setup-go@v3
        with:
          go-version: "stable"
          cache: true
      - name: go get -u
        run: |
          go get -u $PACKAGES
          go mod tidy
      - name: Compile dd-trace-go
        run: go build $PACKAGES
      - name: Test dd-trace-go
        run: go test $PACKAGES

  setup-requirements-linux:
    name: 'Compilation and deployment requirements follow Go standards'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        # TODO: cross-compilation
        go: [ "1.21", "1.20", "1.19" ]
        build-env: [ alpine, bookworm, bullseye ]
        build-with-cgo: [ 0, 1 ]
        deployment-env: [ alpine, debian, al2, al2023, busybox, scratch ]
        deployment-debian-version: [ 12 ]
        include:
          # GitHub limits the number of matrix jobs to 256, so we need to reduce
          # it a bit, and we can reduce redundant tests.
          # 1. Building with `go mod vendoring` is not worth it on all the
          #    possible build and deployment envs.
          - build-env: alpine
            build-with-vendoring: y
            build-with-cgo: 1 # cgo's build tag can impact the vendored files
            deployment-env: alpine
          - build-env: alpine
            build-with-vendoring: y
            build-with-cgo: 0 # cgo's build tag can impact the vendored files
            deployment-env: alpine

        exclude:
          # Exclude "out of the box" cases requiring extra setup:
          # 1. Building with CGO enabled on alpine but deploying to a non-alpine
          #    environment: the C library isn't located at the same place.
          - build-env: alpine
            build-with-cgo: 1
            deployment-env: debian
          - build-env: alpine
            build-with-cgo: 1
            deployment-env: al2
          - build-env: alpine
            build-with-cgo: 1
            deployment-env: al2023
          - build-env: alpine
            build-with-cgo: 1
            deployment-env: busybox
          - build-env: alpine
            build-with-cgo: 1
            deployment-env: scratch
          # 2. Too old glibc on the deployment environment than on the build env
          - build-env: bookworm
            deployment-env: al2
          # 3. Build with CGO enabled and deploying to a scratch docker image
          #    requires copying the dynamic lib dependencies (full example
          #    provided at https://github.com/DataDog/appsec-go-test-app/blob/main/examples/docker/scratch/Dockerfile)
          - build-with-cgo: 1
            deployment-env: scratch

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref || github.ref }}
      - uses: docker/setup-buildx-action@v3
      - name: Build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./internal/apps/setup-smoke-test/Dockerfile
          push: false
          load: true
          tags: smoke-test
          build-args: |
            go=${{ matrix.go }}
            build_env=${{ matrix.build-env }}
            build_with_vendoring=${{ matrix.build-with-vendoring }}
            build_with_cgo=${{ matrix.build-with-cgo }}
            deployment_env=${{ matrix.deployment-env }}
            deployment_debian_env_version=${{ matrix.deployment-debian-version }}
      - name: Test
        run: docker run -p7777:7777 --rm smoke-test
